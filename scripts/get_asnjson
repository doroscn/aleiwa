#!/bin/bash

REPO_ROOT="$(git rev-parse --show-toplevel)"
COUNTRY_CODES_FILE="$REPO_ROOT/asn/countrylist"
OUTPUT_DIR="$REPO_ROOT/asn/country_data"

mkdir -p "$OUTPUT_DIR"

CURRENT_DATE=$(date +"%d/%m/%Y")

if [[ ! -f "$COUNTRY_CODES_FILE" ]]; then
  echo "国家代码文件 $COUNTRY_CODES_FILE 不存在。"
  exit 1
fi

while read -r LINE; do
  COUNTRY_CODE=$(echo "$LINE" | awk '{print $1}')
  [[ -z "$COUNTRY_CODE" ]] && continue

  URL="https://stats.labs.apnic.net/cgi-bin/aspop?c=${COUNTRY_CODE}&d=${CURRENT_DATE}&w=120&d=${CURRENT_DATE}&f=j"
  OUTPUT_FILE="${OUTPUT_DIR}/${COUNTRY_CODE}.json"

  echo "请求 ${COUNTRY_CODE} 的数据..."
  curl -s "$URL" -o "$OUTPUT_FILE"

  if [[ $? -eq 0 ]]; then
    echo "保存到 ${OUTPUT_FILE}"
  else
    echo "请求失败: ${COUNTRY_CODE}"
  fi
done < "$COUNTRY_CODES_FILE"

echo "数据更新完成。"
