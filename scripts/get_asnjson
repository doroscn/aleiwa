#!/bin/bash

# 写死本地国家代码文件路径
COUNTRY_CODES_FILE="./countrylist"

# 检查文件是否存在
if [[ ! -f "$COUNTRY_CODES_FILE" ]]; then
  echo "文件 $COUNTRY_CODES_FILE 不存在，请检查路径。"
  exit 1
fi

# 获取当前日期（格式：dd/mm/yyyy）
CURRENT_DATE=$(date +"%d/%m/%Y")

# 输出目录
OUTPUT_DIR="country_data"
mkdir -p "$OUTPUT_DIR"

# 遍历国家代码文件
while read -r LINE; do
  # 提取第一列为国家代码（假定文件以空格或制表符分隔）
  COUNTRY_CODE=$(echo "$LINE" | awk '{print $1}')

  # 跳过空行
  if [[ -z "$COUNTRY_CODE" ]]; then
    continue
  fi

  # 动态生成 URL
  URL="https://stats.labs.apnic.net/cgi-bin/aspop?c=${COUNTRY_CODE}&d=${CURRENT_DATE}&w=120&d=${CURRENT_DATE}&f=j"

  # 输出文件路径
  OUTPUT_FILE="${OUTPUT_DIR}/${COUNTRY_CODE}.json"

  echo "正在请求国家代码 ${COUNTRY_CODE} 的数据..."

  # 使用 curl 下载 JSON 数据
  curl -s "$URL" -o "$OUTPUT_FILE"

  # 检查是否成功下载
  if [[ $? -eq 0 ]]; then
    echo "数据已保存到 ${OUTPUT_FILE}"
  else
    echo "请求国家代码 ${COUNTRY_CODE} 数据失败！"
  fi
done < "$COUNTRY_CODES_FILE"

echo "所有国家代码数据请求完成。"